# User-app module services
# Assumes infrastructure services (postgres, redis, etc.) are running via infra/docker-compose.yml

services:
  # User-facing backend API
  user-app-backend:
    build:
      context: ../../..
      dockerfile: modules/user-app/ops/Dockerfile.backend
      target: development
    container_name: testproject_user_app_backend
    environment:
      NODE_ENV: development
      PORT: 3001
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/testproject?schema=public
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      FRONTEND_URL: http://localhost:3000
    ports:
      - "3001:3001"  # Direct access
      - "5555:5555"  # Prisma Studio
    volumes:
      - ../../../modules/user-app/backend:/app/modules/user-app/backend
      - ../../../shared/contexts/Infrastructure:/app/shared/contexts/Infrastructure
      - ../../../shared/contexts/example:/app/shared/contexts/example
      - ../../../shared/database:/app/shared/database
      - ../../../modules/user-app/specs:/app/modules/user-app/specs
      - /app/modules/user-app/backend/node_modules
      - /app/shared/contexts/Infrastructure/persistence/node_modules
      - /app/shared/database/node_modules
      - /app/node_modules
    depends_on:
      - postgres
      - redis
      - rabbitmq
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.user-app-backend.rule=Host(`api.user.local`)"
      - "traefik.http.routers.user-app-backend.entrypoints=web"
      - "traefik.http.services.user-app-backend.loadbalancer.server.port=3001"
    networks:
      - testproject_network

  # User-facing frontend
  user-app-frontend:
    build:
      context: ../../..
      dockerfile: modules/user-app/ops/Dockerfile.frontend
      target: development
    container_name: testproject_user_app_frontend
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: http://localhost:3001
    ports:
      - "3000:3000"  # Direct access
    volumes:
      - ../../../modules/user-app/frontend:/app/modules/user-app/frontend
      - ../../../shared/packages:/app/shared/packages
      - /app/modules/user-app/frontend/node_modules
      - /app/modules/user-app/frontend/.next
      - /app/shared/packages/auth/node_modules
      - /app/shared/packages/ui/node_modules
      - /app/node_modules
    depends_on:
      - user-app-backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.user-app-frontend.rule=Host(`user.local`)"
      - "traefik.http.routers.user-app-frontend.entrypoints=web"
      - "traefik.http.services.user-app-frontend.loadbalancer.server.port=3000"
    networks:
      - testproject_network
