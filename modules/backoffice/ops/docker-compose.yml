version: '3.8'

# Backoffice module services
# Assumes infrastructure services (postgres, redis, etc.) are running via infra/docker-compose.yml

services:
  # Backoffice backend API
  backoffice-backend:
    build:
      context: ../../..
      dockerfile: modules/backoffice/ops/Dockerfile.backend
      target: development
    container_name: testproject_backoffice_backend
    environment:
      NODE_ENV: development
      PORT: 3011
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/testproject?schema=public
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      FRONTEND_URL: http://localhost:3010
    ports:
      - "3011:3011"  # Direct access
      - "5556:5555"  # Prisma Studio (different port to avoid conflicts)
    volumes:
      - ../../../modules/backoffice/backend:/app/modules/backoffice/backend
      - ../../../shared/database:/app/shared/database
      - ../../../modules/backoffice/specs:/app/modules/backoffice/specs
      - /app/modules/backoffice/backend/node_modules
      - /app/shared/database/node_modules
      - /app/node_modules
    depends_on:
      - postgres
      - redis
      - rabbitmq
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backoffice-backend.rule=Host(`api.admin.local`)"
      - "traefik.http.routers.backoffice-backend.entrypoints=web"
      - "traefik.http.services.backoffice-backend.loadbalancer.server.port=3011"
    networks:
      - testproject_network

  # Backoffice frontend
  backoffice-frontend:
    build:
      context: ../../..
      dockerfile: modules/backoffice/ops/Dockerfile.frontend
      target: development
    container_name: testproject_backoffice_frontend
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: http://localhost:3011
    ports:
      - "3010:3010"  # Direct access
    volumes:
      - ../../../modules/backoffice/frontend:/app/modules/backoffice/frontend
      - ../../../shared/packages:/app/shared/packages
      - /app/modules/backoffice/frontend/node_modules
      - /app/modules/backoffice/frontend/.next
      - /app/shared/packages/auth/node_modules
      - /app/shared/packages/ui/node_modules
      - /app/node_modules
    depends_on:
      - backoffice-backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backoffice-frontend.rule=Host(`admin.local`)"
      - "traefik.http.routers.backoffice-frontend.entrypoints=web"
      - "traefik.http.services.backoffice-frontend.loadbalancer.server.port=3010"
    networks:
      - testproject_network
