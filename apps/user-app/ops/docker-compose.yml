# User-app services
# Assumes infrastructure services (postgres, redis, etc.) are running via infra/docker-compose.yml

services:
  # User-facing backend API
  user-app-backend:
    build:
      context: ../../..
      dockerfile: apps/user-app/ops/Dockerfile.backend
      target: development
    container_name: testproject_user_app_backend
    # Secrets are loaded from .env.development.local (create from .env.development.local.example)
    env_file:
      - .env.development.local
    environment:
      NODE_ENV: development
      PORT: 3001
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/testproject?schema=public
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672
      FRONTEND_URL: http://user.local:8080
    ports:
      - "3001:3001"  # Direct access
      - "5555:5555"  # Prisma Studio
    volumes:
      - ../../../:/app
      - /app/apps/user-app/backend/node_modules
      - /app/apps/backoffice/backend/node_modules
      - /app/src/shared/infrastructure/persistence/node_modules
      - /app/src/shared/node_modules
      - /app/src/backoffice/node_modules
      - /app/src/user-facing-app/node_modules
      - /app/node_modules
    depends_on:
      - postgres
      - redis
      - rabbitmq
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.user-app-backend.rule=Host(`api.user.local`)"
      - "traefik.http.routers.user-app-backend.entrypoints=web"
      - "traefik.http.services.user-app-backend.loadbalancer.server.port=3001"
    networks:
      - testproject_network

  # User-facing frontend
  user-app-frontend:
    build:
      context: ../../..
      dockerfile: apps/user-app/ops/Dockerfile.frontend
      target: development
    container_name: testproject_user_app_frontend
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: http://api.user.local:8080
    ports:
      - "3000:3000"  # Direct access
    volumes:
      - ../../../apps/user-app/frontend:/app/apps/user-app/frontend
      - /app/apps/user-app/frontend/node_modules
      - /app/apps/user-app/frontend/.next
      - /app/node_modules
    depends_on:
      - user-app-backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.user-app-frontend.rule=Host(`user.local`)"
      - "traefik.http.routers.user-app-frontend.entrypoints=web"
      - "traefik.http.services.user-app-frontend.loadbalancer.server.port=3000"
    networks:
      - testproject_network
